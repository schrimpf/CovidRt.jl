<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Paul Schrimpf">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Exploratory Plots - CovidRt.jl</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atelier-dune-light.min.css">
        <link href="../assets/Documenter.css" rel="stylesheet">
        <link href="../assets/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">CovidRt.jl</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Package Docs</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Reproductive number estimates <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Rt/" class="dropdown-item">Systrom Approach</a>
</li>
                                    
<li>
    <a href="../rt_longdiff/" class="dropdown-item">Long-differening</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Exploratory Plots</a>
</li>
                                    
<li>
    <a href="../rt_onlym/" class="dropdown-item">Without policies</a>
</li>
                                    
<li>
    <a href="../extensions/" class="dropdown-item">Extensions</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../rt_longdiff/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../rt_onlym/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/schrimpf/CovidRt.jl/edit/master/docs/exploratory.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#introduction" class="nav-link">Introduction</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#choosing-lag-length" class="nav-link">Choosing lag length</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#moving-average-measurement-variables" class="nav-link">Moving average measurement variables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#removing-common-time-trends" class="nav-link">Removing common time trends</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>This section contains some exploratory plots.</p>
<pre><code class="julia">using CovidData
using CovidRt
</code></pre>

<pre><code>Error: importing CovidRt into Main conflicts with an existing identifier
</code></pre>
<pre><code class="julia">using TransformVariables, Parameters, Plots,  StatsPlots, DataFrames, Dates, LinearAlgebra, Distributions, Random, LogDensityProblems, DynamicHMC, MCMCChains, JLD2, Latexify
Plots.pyplot()
df = CovidData.statedata(policies=:indicators, fillmissingmobility=true)
df[!,:log_encounters_rate] = log.(1 .+ df[!,:encounters_rate])

# create ΔlogΔcases
sdf = filter(x-&gt;x.fips &lt; 60, df)
sort!(sdf, (:state, :date))
L1 = L2 = 7
sdf[!,:Δcases] = by(sdf, :state, Δcases = Symbol(&quot;cases.nyt&quot;) =&gt; x-&gt;lagdiff(x, L1))[!,:Δcases]./L1
sdf[!,:ΔlogΔcases] = by(sdf, :state, ΔlogΔcases =:Δcases =&gt; x-&gt;lagdiff(log.(max.(x,0.1)), L2))[!,:ΔlogΔcases]./L2


googlevars = [:retail_and_recreation_percent_change_from_baseline,
              :grocery_and_pharmacy_percent_change_from_baseline,
              :parks_percent_change_from_baseline ,
              :transit_stations_percent_change_from_baseline,
              :workplaces_percent_change_from_baseline,
              :residential_percent_change_from_baseline]
homebasevars = [:percentchangehours,
                :percentchangebusinesses]
unacastvars = [:n_grade_total,
               :daily_distance_diff,
               :n_grade_distance,
               :daily_visitation_diff,
               :n_grade_visitation,
               :log_encounters_rate,
               :n_grade_encounters]
</code></pre>

<pre><code>7-element Array{Symbol,1}:
 :n_grade_total
 :daily_distance_diff
 :n_grade_distance
 :daily_visitation_diff
 :n_grade_visitation
 :log_encounters_rate
 :n_grade_encounters
</code></pre>
<h2 id="choosing-lag-length">Choosing lag length<a class="headerlink" href="#choosing-lag-length" title="Permanent link">&para;</a></h2>
<p>Here we plot time series of $\Delta \log(\Delta cases)$ and each of the
activity measurements.</p>
<p>We also plot the covariances of $\Delta \log(\Delta cases)$ and
$m(t+\ell)$ as a function of $\ell$ for each of the activity measurement
variables, $m$</p>
<pre><code class="julia">datelim = (Date(&quot;2020-03-07&quot;), Dates.today())
xlim = Dates.value.(datelim)
function acf(df, id, t, x, y, tdiffs=[-20:20]; correlation=false)
  if !issorted(df, (id, t))
    @error &quot;df not sorted&quot;
  end
  X = df[!,x]
  c = zeros(size(tdiffs))
  cfn = correlation ? cor : cov
  for (i, t) in enumerate(tdiffs)
    ylag = by(df, id, ylag= y =&gt; z-&gt;CovidRt.lag(z,t))[!,:ylag]
    inc = .!ismissing.(X) .&amp; .!(ismissing.(ylag))
    c[i] = cfn(X[inc],ylag[inc])
  end
  return(c)
end

states_to_plot = [&quot;New York&quot;, &quot;New Jersey&quot;,&quot;Massachusetts&quot;,&quot;California&quot;,
                  &quot;Georgia&quot;,&quot;Illinois&quot;,&quot;Michigan&quot;,
                  &quot;Ohio&quot;,&quot;Wisconsin&quot;,&quot;Washington&quot;]
vars = vcat(googlevars, homebasevars, unacastvars)
states_to_plot = [&quot;New York&quot;, &quot;New Jersey&quot;,&quot;Massachusetts&quot;,&quot;California&quot;,
                  &quot;Georgia&quot;,&quot;Illinois&quot;,&quot;Michigan&quot;,
                  &quot;Ohio&quot;,&quot;Wisconsin&quot;,&quot;Washington&quot;]

vars = vcat(googlevars, homebasevars, unacastvars)

function explorelags(vars, sdf, states_to_plot; toplot=vars, tdiffs=-10:40, correlation=true)
  argmaxc = zeros(Int64,length(vars))
  maxc = zeros(length(vars))
  for (j,v) in enumerate(vars)
    if v in toplot
      fig = Vector{Any}(undef, length(states_to_plot))
      for (i, st) in enumerate(states_to_plot)
        subdf = filter(x-&gt;x.state.==st, sdf)
        fig[i] = @df subdf plot(:date, :ΔlogΔcases, title=st,  color=colors[1], ylab=&quot;ΔlogΔcases&quot;, xlim=xlim, legend=:topleft, labels=&quot;ΔlogΔcases&quot;)
        fig[i] =  twinx()
        fig[i] = plot!(fig[i],subdf[!,:date], subdf[!,v], color=colors[2], labels=string(v), ylab=string(v), xlim=xlim, legend=:topright)
      end
      display(plot(fig[1:9]..., layout=(3,3), reuse=false))
    end

    c = acf(sdf, :state, :date, :ΔlogΔcases, v, tdiffs, correlation=correlation)
    a = argmax(abs.(c))
    argmaxc[j] = tdiffs[a]
    maxc[j] =  c[a]
    cword = correlation ? &quot;Correlation&quot; : &quot;Covariance&quot;
    if v in toplot
      fig=plot(tdiffs, c, title=&quot;$cword of ΔlogΔcases[t] &amp; $(string(v))[t+ℓ]&quot;,
               xlab=&quot;ℓ&quot;,  ylab=&quot;$cword&quot;, legend=:none, linewidth=1.5)
      display(plot(fig, reuse=false))
    end
  end

  cword = correlation ? &quot;cor&quot; : &quot;cov&quot;
  tbl = vcat([&quot;Variable&quot; &quot;ℓ maximum $cword&quot; &quot;maximum $cword&quot;],[replace.(string.(vars),r&quot;\_&quot;=&gt;s&quot; &quot;) argmaxc maxc])
  if !correlation
    tbl=hcat(tbl, [&quot;variance&quot;, [var(skipmissing(sdf[!,v])) for v in vars]...])
  end
  return(latexify(tbl, env=:mdtable, latex=false, fmt=&quot;%.2f&quot;))
end

tbl=explorelags(vars, sdf, states_to_plot;
                toplot=[:residential_percent_change_from_baseline,
                        :percentchangebusinesses,
                        :n_grade_total,
                        :daily_visitation_diff,
                        :log_encounters_rate])
</code></pre>

<table>
<thead>
<tr>
<th align="right">Variable</th>
<th align="right">ℓ maximum cor</th>
<th align="right">maximum cor</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">retail and recreation percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">0.80</td>
</tr>
<tr>
<td align="right">grocery and pharmacy percent change from baseline</td>
<td align="right">11.00</td>
<td align="right">0.66</td>
</tr>
<tr>
<td align="right">parks percent change from baseline</td>
<td align="right">16.00</td>
<td align="right">0.27</td>
</tr>
<tr>
<td align="right">transit stations percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">0.72</td>
</tr>
<tr>
<td align="right">workplaces percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">0.80</td>
</tr>
<tr>
<td align="right">residential percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">-0.75</td>
</tr>
<tr>
<td align="right">percentchangehours</td>
<td align="right">15.00</td>
<td align="right">0.80</td>
</tr>
<tr>
<td align="right">percentchangebusinesses</td>
<td align="right">14.00</td>
<td align="right">0.79</td>
</tr>
<tr>
<td align="right">n grade total</td>
<td align="right">14.00</td>
<td align="right">-0.67</td>
</tr>
<tr>
<td align="right">daily distance diff</td>
<td align="right">14.00</td>
<td align="right">0.75</td>
</tr>
<tr>
<td align="right">n grade distance</td>
<td align="right">14.00</td>
<td align="right">-0.63</td>
</tr>
<tr>
<td align="right">daily visitation diff</td>
<td align="right">15.00</td>
<td align="right">0.79</td>
</tr>
<tr>
<td align="right">n grade visitation</td>
<td align="right">15.00</td>
<td align="right">-0.47</td>
</tr>
<tr>
<td align="right">log encounters rate</td>
<td align="right">16.00</td>
<td align="right">0.49</td>
</tr>
<tr>
<td align="right">n grade encounters</td>
<td align="right">15.00</td>
<td align="right">-0.44</td>
</tr>
</tbody>
</table>
<p><img alt="" src="../figures/exploratory_2_1.png" /> <img alt="" src="../figures/exploratory_2_2.png" />
<img alt="" src="../figures/exploratory_2_3.png" /> <img alt="" src="../figures/exploratory_2_4.png" />
<img alt="" src="../figures/exploratory_2_5.png" /> <img alt="" src="../figures/exploratory_2_6.png" />
<img alt="" src="../figures/exploratory_2_7.png" /> <img alt="" src="../figures/exploratory_2_8.png" />
<img alt="" src="../figures/exploratory_2_9.png" /> <img alt="" src="../figures/exploratory_2_10.png" /></p>
<pre><code class="julia">println(tbl)
</code></pre>

<table>
<thead>
<tr>
<th align="right">Variable</th>
<th align="right">ℓ maximum cor</th>
<th align="right">maximum cor</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">retail and recreation percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">0.80</td>
</tr>
<tr>
<td align="right">grocery and pharmacy percent change from baseline</td>
<td align="right">11.00</td>
<td align="right">0.66</td>
</tr>
<tr>
<td align="right">parks percent change from baseline</td>
<td align="right">16.00</td>
<td align="right">0.27</td>
</tr>
<tr>
<td align="right">transit stations percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">0.72</td>
</tr>
<tr>
<td align="right">workplaces percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">0.80</td>
</tr>
<tr>
<td align="right">residential percent change from baseline</td>
<td align="right">15.00</td>
<td align="right">-0.75</td>
</tr>
<tr>
<td align="right">percentchangehours</td>
<td align="right">15.00</td>
<td align="right">0.80</td>
</tr>
<tr>
<td align="right">percentchangebusinesses</td>
<td align="right">14.00</td>
<td align="right">0.79</td>
</tr>
<tr>
<td align="right">n grade total</td>
<td align="right">14.00</td>
<td align="right">-0.67</td>
</tr>
<tr>
<td align="right">daily distance diff</td>
<td align="right">14.00</td>
<td align="right">0.75</td>
</tr>
<tr>
<td align="right">n grade distance</td>
<td align="right">14.00</td>
<td align="right">-0.63</td>
</tr>
<tr>
<td align="right">daily visitation diff</td>
<td align="right">15.00</td>
<td align="right">0.79</td>
</tr>
<tr>
<td align="right">n grade visitation</td>
<td align="right">15.00</td>
<td align="right">-0.47</td>
</tr>
<tr>
<td align="right">log encounters rate</td>
<td align="right">16.00</td>
<td align="right">0.49</td>
</tr>
<tr>
<td align="right">n grade encounters</td>
<td align="right">15.00</td>
<td align="right">-0.44</td>
</tr>
</tbody>
</table>
<p>Some comments:</p>
<ul>
<li>
<p>There is are noticeable weekend effects, especially in
    <code>residential   percent change from baseline</code> from Google mobility
    reports.</p>
</li>
<li>
<p>There’s some effect of Easter visible in <code>percent change business</code></p>
</li>
<li>
<p>The variables <code>n grade total</code>, <code>daily visitation diff</code> and
    <code>encounters rate</code> are from
    <a href="https://www.unacast.com/covid19/social-distancing-scoreboard">Unacast</a>.</p>
</li>
<li>
<p>It is not just a coincidence that the maximum autocovariance is at
    $14 = L_1 + L_2$. The timing convention being followed here is that</p>
<p>
<script type="math/tex; mode=display">
(\Delta \log \Delta cases)[t] = \log(cases[t] - cases[t-L_1]) - \log(cases[t-L_2] - cases[t-L_2-L1])
</script>
</p>
<p>so it is no surprise that lags of these measurement errors are
correletaed with $\Delta log \Delta cases[t]$.</p>
</li>
</ul>
<h3 id="given-the-long-differencing-what-are-the-correct-lags-of-measurement-variables-to-use">Given the long differencing, what are the correct lags of measurement variables to use?<a class="headerlink" href="#given-the-long-differencing-what-are-the-correct-lags-of-measurement-variables-to-use" title="Permanent link">&para;</a></h3>
<p>In discrete time, the model is</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
\Delta C_t & = \tau I_t \\
I_t & = (1+\gamma (R_t - 1)) I_{t-1}
\end{align*}
</script>
</p>
<p>Combining these we get</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
C_{t} - C_{t - L_1} = & \sum_{s={t-L_1+1}^{t} \left(\prod_{r=t-L_1+1}^s 1 + \gamma (R_r - 1) \right) I_{t-L_1} \\
 = & (1+\gamma(\overline{R}_{t-L_1,t}) ) I_{t-L_1} \\
 = & (1+\gamma(\overline{R}_{t-L_1,t})) (1+\gamma(\overline{R}_{t-L_1-L_2,t-L_1})) I_{t-L_1-L2}
\end{align*}
</script>
</p>
<p>where $\overline{R}_{t-L_1, t}$ is the “average”<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> effective
reproductive from time $t-L_1$ to $t$.</p>
<p>Similarly, <script type="math/tex; mode=display">
C_{t-L_2} - C_{t - L_2 - L_1} = (1+\gamma(\overline{R}_{t-L_1-L_2,t-L_2}) ) I_{t-L_1-L_2}
</script>
</p>
<p>If $L_1 = L_2$, then we get some convenient cancellations when taking
the log difference:</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
\log (C_t - C_{t-L}) - \log(C_{t-L} - C_{t - 2L}) = & \log( 1 + \gamma(\overline{R}_{t-L,t}) ) \\
\approx & \gamma (\overline{R}_{t-L,t} - 1)
</script>
</p>
<p>!!! question Is this $L_1 = L_2$ condition correct and general? Or some
artifact of this derivation? I think it would appear if the model were
in continuous time as well.</p>
<p>From this derivation, we see that <code>ΔlogΔcases[t]</code> should depend on the
reproductive number of confirmed cases from time $t-L$ to $t$. Since
there is a delay between infection and detection, the reproductive
number of confirmed cases, depends on actual conditions some time
further in the past.</p>
<h2 id="moving-average-measurement-variables">Moving average measurement variables<a class="headerlink" href="#moving-average-measurement-variables" title="Permanent link">&para;</a></h2>
<p>Motivated by the analysis in the previous section, we will use the
moving average from $t-L$ to time $t$ in place of each measurement
variable at time $t$.</p>
<pre><code class="julia">L = 7
sdf = filter(x-&gt;x.fips &lt; 60, df)
sort!(sdf, (:state, :date))
sdf[!,:Δcases] = by(sdf, :state, Δcases = Symbol(&quot;cases.nyt&quot;) =&gt; x-&gt;lagdiff(x, L))[!,:Δcases]./L
sdf[!,:ΔlogΔcases] = by(sdf, :state, ΔlogΔcases =:Δcases =&gt; x-&gt;lagdiff(log.(max.(x,0.1)), L))[!,:ΔlogΔcases]./L
w = vcat(ones(L+1), zeros(L))
for v in vcat(googlevars, homebasevars, unacastvars)
  sdf[!,v]=by(sdf, :state, x = v =&gt; x-&gt;CovidRt.smooth(x,w=w))[!,:x]
end

tbl=explorelags(vars, sdf, states_to_plot;
                toplot=[:residential_percent_change_from_baseline,
                        :percentchangebusinesses,
                        :n_grade_total,
                        :log_encounters_rate], correlation=false)
</code></pre>

<table>
<thead>
<tr>
<th align="right">Variable</th>
<th align="right">ℓ maximum cov</th>
<th align="right">maximum cov</th>
<th align="right">variance</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">retail and recreation percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">2.24</td>
<td align="right">426.19</td>
</tr>
<tr>
<td align="right">grocery and pharmacy percent change from baseline</td>
<td align="right">9.00</td>
<td align="right">1.23</td>
<td align="right">184.22</td>
</tr>
<tr>
<td align="right">parks percent change from baseline</td>
<td align="right">13.00</td>
<td align="right">1.23</td>
<td align="right">855.44</td>
</tr>
<tr>
<td align="right">transit stations percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">2.14</td>
<td align="right">534.46</td>
</tr>
<tr>
<td align="right">workplaces percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">2.03</td>
<td align="right">363.65</td>
</tr>
<tr>
<td align="right">residential percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">-0.79</td>
<td align="right">57.28</td>
</tr>
<tr>
<td align="right">percentchangehours</td>
<td align="right">14.00</td>
<td align="right">2.68</td>
<td align="right">636.21</td>
</tr>
<tr>
<td align="right">percentchangebusinesses</td>
<td align="right">13.00</td>
<td align="right">2.02</td>
<td align="right">401.74</td>
</tr>
<tr>
<td align="right">n grade total</td>
<td align="right">12.00</td>
<td align="right">-0.08</td>
<td align="right">0.71</td>
</tr>
<tr>
<td align="right">daily distance diff</td>
<td align="right">14.00</td>
<td align="right">0.02</td>
<td align="right">0.03</td>
</tr>
<tr>
<td align="right">n grade distance</td>
<td align="right">11.00</td>
<td align="right">-0.07</td>
<td align="right">0.67</td>
</tr>
<tr>
<td align="right">daily visitation diff</td>
<td align="right">14.00</td>
<td align="right">0.02</td>
<td align="right">0.05</td>
</tr>
<tr>
<td align="right">n grade visitation</td>
<td align="right">10.00</td>
<td align="right">-0.08</td>
<td align="right">1.26</td>
</tr>
<tr>
<td align="right">log encounters rate</td>
<td align="right">14.00</td>
<td align="right">0.11</td>
<td align="right">3.13</td>
</tr>
<tr>
<td align="right">n grade encounters</td>
<td align="right">14.00</td>
<td align="right">-0.08</td>
<td align="right">2.16</td>
</tr>
</tbody>
</table>
<p><img alt="" src="../figures/exploratory_4_1.png" /> <img alt="" src="../figures/exploratory_4_2.png" />
<img alt="" src="../figures/exploratory_4_3.png" /> <img alt="" src="../figures/exploratory_4_4.png" />
<img alt="" src="../figures/exploratory_4_5.png" /> <img alt="" src="../figures/exploratory_4_6.png" />
<img alt="" src="../figures/exploratory_4_7.png" /> <img alt="" src="../figures/exploratory_4_8.png" /></p>
<pre><code class="julia">println(tbl)
</code></pre>

<table>
<thead>
<tr>
<th align="right">Variable</th>
<th align="right">ℓ maximum cov</th>
<th align="right">maximum cov</th>
<th align="right">variance</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">retail and recreation percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">2.24</td>
<td align="right">426.19</td>
</tr>
<tr>
<td align="right">grocery and pharmacy percent change from baseline</td>
<td align="right">9.00</td>
<td align="right">1.23</td>
<td align="right">184.22</td>
</tr>
<tr>
<td align="right">parks percent change from baseline</td>
<td align="right">13.00</td>
<td align="right">1.23</td>
<td align="right">855.44</td>
</tr>
<tr>
<td align="right">transit stations percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">2.14</td>
<td align="right">534.46</td>
</tr>
<tr>
<td align="right">workplaces percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">2.03</td>
<td align="right">363.65</td>
</tr>
<tr>
<td align="right">residential percent change from baseline</td>
<td align="right">14.00</td>
<td align="right">-0.79</td>
<td align="right">57.28</td>
</tr>
<tr>
<td align="right">percentchangehours</td>
<td align="right">14.00</td>
<td align="right">2.68</td>
<td align="right">636.21</td>
</tr>
<tr>
<td align="right">percentchangebusinesses</td>
<td align="right">13.00</td>
<td align="right">2.02</td>
<td align="right">401.74</td>
</tr>
<tr>
<td align="right">n grade total</td>
<td align="right">12.00</td>
<td align="right">-0.08</td>
<td align="right">0.71</td>
</tr>
<tr>
<td align="right">daily distance diff</td>
<td align="right">14.00</td>
<td align="right">0.02</td>
<td align="right">0.03</td>
</tr>
<tr>
<td align="right">n grade distance</td>
<td align="right">11.00</td>
<td align="right">-0.07</td>
<td align="right">0.67</td>
</tr>
<tr>
<td align="right">daily visitation diff</td>
<td align="right">14.00</td>
<td align="right">0.02</td>
<td align="right">0.05</td>
</tr>
<tr>
<td align="right">n grade visitation</td>
<td align="right">10.00</td>
<td align="right">-0.08</td>
<td align="right">1.26</td>
</tr>
<tr>
<td align="right">log encounters rate</td>
<td align="right">14.00</td>
<td align="right">0.11</td>
<td align="right">3.13</td>
</tr>
<tr>
<td align="right">n grade encounters</td>
<td align="right">14.00</td>
<td align="right">-0.08</td>
<td align="right">2.16</td>
</tr>
</tbody>
</table>
<p>Even after this adjustment, there is some mechanical dependence between
when the maximum correlation occurs and $L$.</p>
<pre><code class="julia">for L in [1, 3, 7, 10, 14]
  sdf = filter(x-&gt;x.fips &lt; 60, df)
  sort!(sdf, (:state, :date))
  sdf[!,:Δcases] = by(sdf, :state, Δcases = Symbol(&quot;cases.nyt&quot;) =&gt; x-&gt;lagdiff(x, L))[!,:Δcases]./L
  sdf[!,:ΔlogΔcases] = by(sdf, :state, ΔlogΔcases =:Δcases =&gt; x-&gt;lagdiff(log.(max.(x,0.1)), L))[!,:ΔlogΔcases]./L
  w = vcat(ones(L+1), zeros(L))
  for v in vcat(googlevars, homebasevars, unacastvars)
    sdf[!,v]=by(sdf, :state, x = v =&gt; x-&gt;CovidRt.smooth(x,w=w))[!,:x]
  end

  @show L
  tbl=explorelags(vars, sdf, states_to_plot;
                  toplot=[], correlation=false)
  println(&quot;\nL = $L&quot;)
  println(tbl)
end
</code></pre>

<p>L = 1</p>
<p>L = 1 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 7.00 | 2.57 | 404.51 | | grocery and
pharmacy percent change from baseline | 5.00 | 1.77 | 206.00 | |
parks percent change from baseline | 9.00 | 1.70 | 1435.15 | |
transit stations percent change from baseline | 4.00 | 2.55 | 513.03
| | workplaces percent change from baseline | 4.00 | 2.61 | 340.96
| | residential percent change from baseline | 4.00 | -1.01 | 58.31
| | percentchangehours | 8.00 | 3.05 | 580.19 | |
percentchangebusinesses | 7.00 | 2.56 | 383.69 | | n grade total |
7.00 | -0.10 | 0.76 | | daily distance diff | 7.00 | 0.02 | 0.03
| | n grade distance | 0.00 | -0.10 | 0.76 | | daily visitation
diff | 7.00 | 0.03 | 0.05 | | n grade visitation | 7.00 | -0.12
| 1.58 | | log encounters rate | 7.00 | 0.12 | 3.07 | | n grade
encounters | 7.00 | -0.09 | 2.23 |</p>
<p>L = 3</p>
<p>L = 3 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 8.00 | 2.39 | 410.84 | | grocery and
pharmacy percent change from baseline | 6.00 | 1.51 | 193.41 | |
parks percent change from baseline | 10.00 | 1.37 | 1116.30 | |
transit stations percent change from baseline | 6.00 | 2.37 | 520.55
| | workplaces percent change from baseline | 6.00 | 2.23 | 346.41
| | residential percent change from baseline | 11.00 | -0.85 |
56.31 | | percentchangehours | 7.00 | 2.91 | 601.86 | |
percentchangebusinesses | 6.00 | 2.32 | 390.19 | | n grade total |
8.00 | -0.09 | 0.72 | | daily distance diff | 8.00 | 0.02 | 0.03
| | n grade distance | 7.00 | -0.09 | 0.70 | | daily visitation
diff | 8.00 | 0.03 | 0.05 | | n grade visitation | 8.00 | -0.09
| 1.40 | | log encounters rate | 9.00 | 0.11 | 3.08 | | n grade
encounters | 8.00 | -0.09 | 2.19 |</p>
<p>L = 7</p>
<p>L = 7 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 14.00 | 2.24 | 426.19 | | grocery
and pharmacy percent change from baseline | 9.00 | 1.23 | 184.22 |
| parks percent change from baseline | 13.00 | 1.23 | 855.44 | |
transit stations percent change from baseline | 14.00 | 2.14 | 534.46
| | workplaces percent change from baseline | 14.00 | 2.03 | 363.65
| | residential percent change from baseline | 14.00 | -0.79 |
57.28 | | percentchangehours | 14.00 | 2.68 | 636.21 | |
percentchangebusinesses | 13.00 | 2.02 | 401.74 | | n grade total
| 12.00 | -0.08 | 0.71 | | daily distance diff | 14.00 | 0.02 |
0.03 | | n grade distance | 11.00 | -0.07 | 0.67 | | daily
visitation diff | 14.00 | 0.02 | 0.05 | | n grade visitation |
10.00 | -0.08 | 1.26 | | log encounters rate | 14.00 | 0.11 |
3.13 | | n grade encounters | 14.00 | -0.08 | 2.16 |</p>
<p>L = 10</p>
<p>L = 10 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 17.00 | 1.84 | 433.12 | | grocery
and pharmacy percent change from baseline | 12.00 | 1.02 | 179.09 |
| parks percent change from baseline | 16.00 | 1.01 | 771.06 | |
transit stations percent change from baseline | 17.00 | 1.73 | 538.38
| | workplaces percent change from baseline | 17.00 | 1.66 | 371.54
| | residential percent change from baseline | 18.00 | -0.65 |
58.46 | | percentchangehours | 16.00 | 2.22 | 647.28 | |
percentchangebusinesses | 15.00 | 1.66 | 406.18 | | n grade total
| 14.00 | -0.06 | 0.71 | | daily distance diff | 16.00 | 0.01 |
0.03 | | n grade distance | 14.00 | -0.06 | 0.66 | | daily
visitation diff | 18.00 | 0.02 | 0.05 | | n grade visitation |
14.00 | -0.06 | 1.21 | | log encounters rate | 17.00 | 0.09 |
3.17 | | n grade encounters | 15.00 | -0.07 | 2.14 |</p>
<p>L = 14</p>
<p>L = 14 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 20.00 | 1.27 | 432.02 | | grocery
and pharmacy percent change from baseline | 15.00 | 0.72 | 170.79 |
| parks percent change from baseline | 19.00 | 0.70 | 684.35 | |
transit stations percent change from baseline | 19.00 | 1.15 | 532.44
| | workplaces percent change from baseline | 19.00 | 1.13 | 373.17
| | residential percent change from baseline | 20.00 | -0.44 |
58.48 | | percentchangehours | 19.00 | 1.53 | 644.77 | |
percentchangebusinesses | 17.00 | 1.14 | 402.23 | | n grade total
| 16.00 | -0.05 | 0.70 | | daily distance diff | 19.00 | 0.01 |
0.03 | | n grade distance | 16.00 | -0.04 | 0.64 | | daily
visitation diff | 21.00 | 0.01 | 0.05 | | n grade visitation |
16.00 | -0.04 | 1.13 | | log encounters rate | 19.00 | 0.07 |
3.20 | | n grade encounters | 17.00 | -0.05 | 2.12 |</p>
<h2 id="removing-common-time-trends">Removing common time trends<a class="headerlink" href="#removing-common-time-trends" title="Permanent link">&para;</a></h2>
<p>In large part, the correlation between lagged measurement errors and
$\Delta \log \Delta C$ is driven by a common decreasing time trend. When
this decrease occurs shifts with $L$, so that might explain why the
maximal correlation depends on $L$. Here, we will repeat some of the
above analysis after removing time effects.</p>
<pre><code class="julia">mvars = vcat(googlevars, homebasevars, unacastvars)
adf = aggregate(select(sdf, :date, :ΔlogΔcases),:date,
                [x-&gt;mean(skipmissing(x)), x-&gt;sqrt(var(skipmissing(x))) ],
                sort=true)
n = length(unique(sdf.state))
@df adf plot(:date, :ΔlogΔcases_function, legend=:none, xlim=xlim,
             ribbon=1.64/sqrt(n)*:ΔlogΔcases_function_1, ylab=&quot;ΔlogΔcases&quot;,
             title=&quot;Average ΔlogΔcases&quot;)
</code></pre>

<p><img alt="" src="../figures/exploratory_7_1.png" /></p>
<pre><code class="julia">for L in [1, 3, 7, 10, 14]
  sdf = filter(x-&gt;x.fips &lt; 60, df)
  sort!(sdf, (:state, :date))
  sdf[!,:Δcases] = by(sdf, :state, Δcases = Symbol(&quot;cases.nyt&quot;) =&gt; x-&gt;lagdiff(x, L))[!,:Δcases]./L
  sdf[!,:ΔlogΔcases] = by(sdf, :state, ΔlogΔcases =:Δcases =&gt; x-&gt;lagdiff(log.(max.(x,0.1)), L))[!,:ΔlogΔcases]./L
  w = vcat(ones(L+1), zeros(L))
  for v in mvars
    sdf[!,v]=by(sdf, :state, x = v =&gt; x-&gt;CovidRt.smooth(x,w=w))[!,:x]
  end

  adf = aggregate(select(sdf, :date, :ΔlogΔcases, mvars...),:date,
                  [x-&gt;mean(skipmissing(x))],  sort=true)

  sdf = join(sdf, adf, on=:date)
  for v in vcat(:ΔlogΔcases, mvars)
    sdf[!,v] .= sdf[!,v] .- sdf[!, Symbol(string(v)*&quot;_function&quot;)]
  end

  toplot = L==7 ? [:residential_percent_change_from_baseline,
                   :percentchangebusinesses,
                   :n_grade_total,
                   :log_encounters_rate] : []
  tbl=explorelags(vars, sdf, states_to_plot;
                  toplot=toplot, tdiffs=-10:40, correlation=false)
  println(&quot;\nL = $L&quot;)
  println(tbl)
end
</code></pre>

<p>L = 1 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 31.00 | 0.15 | 57.34 | | grocery and
pharmacy percent change from baseline | 31.00 | 0.23 | 52.65 | |
parks percent change from baseline | 37.00 | 0.93 | 1266.70 | |
transit stations percent change from baseline | 24.00 | 0.19 | 196.32
| | workplaces percent change from baseline | -10.00 | -0.08 |
36.79 | | residential percent change from baseline | -10.00 | 0.06
| 8.43 | | percentchangehours | 9.00 | 0.17 | 90.19 | |
percentchangebusinesses | 22.00 | 0.13 | 62.22 | | n grade total |
-9.00 | -0.01 | 0.32 | | daily distance diff | 18.00 | 0.00 |
0.01 | | n grade distance | 19.00 | -0.01 | 0.28 | | daily
visitation diff | 1.00 | 0.00 | 0.00 | | n grade visitation |
18.00 | -0.01 | 0.92 | | log encounters rate | -9.00 | 0.04 |
2.52 | | n grade encounters | -9.00 | -0.04 | 1.88 |</p>
<p>L = 3 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 0.00 | 0.08 | 51.55 | | grocery and
pharmacy percent change from baseline | 40.00 | 0.09 | 46.27 | |
parks percent change from baseline | 18.00 | 0.38 | 983.44 | |
transit stations percent change from baseline | 25.00 | 0.11 | 187.14
| | workplaces percent change from baseline | 0.00 | 0.05 | 34.53
| | residential percent change from baseline | -10.00 | 0.02 | 7.71
| | percentchangehours | 0.00 | 0.10 | 83.09 | |
percentchangebusinesses | 17.00 | 0.08 | 58.55 | | n grade total |
3.00 | -0.01 | 0.30 | | daily distance diff | 2.00 | 0.00 | 0.01
| | n grade distance | 26.00 | -0.00 | 0.25 | | daily visitation
diff | 1.00 | 0.00 | 0.00 | | n grade visitation | 18.00 | -0.01
| 0.85 | | log encounters rate | 9.00 | 0.02 | 2.53 | | n grade
encounters | -10.00 | -0.02 | 1.84 |</p>
<p>L = 7 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 5.00 | 0.05 | 44.86 | | grocery and
pharmacy percent change from baseline | 3.00 | 0.05 | 40.90 | |
parks percent change from baseline | 15.00 | 0.30 | 751.90 | |
transit stations percent change from baseline | 4.00 | 0.08 | 173.74
| | workplaces percent change from baseline | 18.00 | 0.03 | 31.80
| | residential percent change from baseline | -10.00 | 0.02 | 7.00
| | percentchangehours | 3.00 | 0.08 | 75.70 | |
percentchangebusinesses | 4.00 | 0.06 | 54.14 | | n grade total |
4.00 | -0.01 | 0.28 | | daily distance diff | 5.00 | 0.00 | 0.01
| | n grade distance | 26.00 | -0.00 | 0.22 | | daily visitation
diff | -10.00 | -0.00 | 0.00 | | n grade visitation | -10.00 |
0.00 | 0.75 | | log encounters rate | -3.00 | 0.02 | 2.55 | | n
grade encounters | -10.00 | -0.02 | 1.79 |</p>
<p>L = 10 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 8.00 | 0.04 | 41.47 | | grocery and
pharmacy percent change from baseline | 9.00 | 0.05 | 38.83 | |
parks percent change from baseline | 16.00 | 0.26 | 676.17 | |
transit stations percent change from baseline | 6.00 | 0.07 | 164.66
| | workplaces percent change from baseline | 15.00 | 0.03 | 30.17
| | residential percent change from baseline | -10.00 | 0.02 | 6.58
| | percentchangehours | 8.00 | 0.08 | 71.48 | |
percentchangebusinesses | 9.00 | 0.05 | 51.14 | | n grade total |
4.00 | -0.01 | 0.27 | | daily distance diff | 6.00 | 0.00 | 0.01
| | n grade distance | 12.00 | -0.00 | 0.21 | | daily visitation
diff | -10.00 | -0.00 | 0.00 | | n grade visitation | -10.00 |
0.00 | 0.69 | | log encounters rate | -10.00 | 0.02 | 2.57 | | n
grade encounters | -10.00 | -0.02 | 1.77 |</p>
<p>L = 14 | Variable | ℓ maximum cov | maximum cov | variance | |
————————————————–:| ————-:| ———–:| ——–:| | retail and recreation
percent change from baseline | 11.00 | 0.03 | 37.86 | | grocery and
pharmacy percent change from baseline | 11.00 | 0.04 | 36.64 | |
parks percent change from baseline | 17.00 | 0.22 | 595.81 | |
transit stations percent change from baseline | 10.00 | 0.05 | 153.38
| | workplaces percent change from baseline | 14.00 | 0.03 | 28.19
| | residential percent change from baseline | -10.00 | 0.02 | 6.10
| | percentchangehours | 11.00 | 0.07 | 66.78 | |
percentchangebusinesses | 11.00 | 0.04 | 47.53 | | n grade total |
5.00 | -0.01 | 0.26 | | daily distance diff | 9.00 | 0.00 | 0.01
| | n grade distance | 15.00 | -0.00 | 0.19 | | daily visitation
diff | -10.00 | -0.00 | 0.00 | | n grade visitation | -10.00 |
0.00 | 0.62 | | log encounters rate | -8.00 | 0.02 | 2.60 | | n
grade encounters | -10.00 | -0.02 | 1.75 |</p>
<p><img alt="" src="../figures/exploratory_8_1.png" /> <img alt="" src="../figures/exploratory_8_2.png" />
<img alt="" src="../figures/exploratory_8_3.png" /> <img alt="" src="../figures/exploratory_8_4.png" />
<img alt="" src="../figures/exploratory_8_5.png" /> <img alt="" src="../figures/exploratory_8_6.png" />
<img alt="" src="../figures/exploratory_8_7.png" /> <img alt="" src="../figures/exploratory_8_8.png" /></p>
<p>The figures above are with $L=7$.</p>
<p>In these tables, we see that removing time fixed effects, the covariance
between <code>ΔlogΔcases</code> and the measurement variables is greatly reduced.
There is not a super clear pattern about what lag has the highest
covariance</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It is not the usual arithmetic mean, but whatever value makes the
equality hold. Such an $\overline{R}$ exists by the intermediate
value theorem.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Paul Schrimpf</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../assets/mathjaxhelper.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
