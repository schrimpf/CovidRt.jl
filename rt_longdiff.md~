Longer Differences and Smoothing
--------------------------------

One way to reduce $\sigma_k/\sigma_R$ is to reduce noise in new cases by
taking a longer difference or smoothing case counts in some other way.
How does this affect the estimation and interpretation of $R_t$?

As in the first section, we start with the approximate recursive
relation $$
C(t) - C(t-1) \equiv \Delta C(t) \approx \frac{\tau(t)}{\tau(t-1)} e^{\gamma (R_t - 1)} \Delta C(t-1)
$$ If we instead look at a longer difference, $$
\begin{align*}
C(t) - C(t-L) = & \sum_{i=0}^{L-1} \Delta C_{t-i} \\
\approx & \sum_{i=0}^{L-1} \frac{\tau(t-i)}{\tau(t-i-1)} e^{\gamma (R_{t-i} - 1)} \Delta C_{t-i-1} \\
= & \overline {T_{t,L} e^{\gamma(R_{t,L} - 1)}} \sum_{i=0}^{L-1}\Delta C_{t-i-1} \\
= & \overline {T_{t,L} e^{\gamma(R_{t,L} - 1)}} \left( C(t-1) - C(t-1-L) \right)
\end{align*}
$$ where $\overline {T_{t,L} e^{\gamma(R_{t,L} - 1)}}$ is some
intermediate value in between the minimum and maximum of the
$\{ \frac{\tau(t-i)}{\tau(t-i-1)} e^{\gamma (R_{t-i} - 1)} \}_{i=0}^{L-1}$.

If testing is constant over time, we can then obtain an interpretable
$\overline{R_{t,L}}$ by using $k_{t,L} =\log(C(t)-C(t-L))$ and following
the procedure above.

If testing varies with time, it becomes hard to separate testing rate
changes from $R_t$ after taking long differnces.

!!! note

    The same analysis can be applied to other smoothing operations, i.e. using
    $$
    \sum_{i=0}^L w_i \Delta C_{t-i}
    $$
    in place of $C(t) - C(t-L)$. However, there's something strange
    about smoothing $C_t$, and then extracting a smoothed component of
    it using the Kalman filter. The inference afterwards is suspect;
    we would essentially be estimating a kernel regression of $C_t$ on
    time, and using the estimated regression as though it's known with
    certainty.

When would long differences reduce variance? Well if
$\Delta C(t) = \Delta C^\ast(t) + \epsilon_t$ with $\epsilon_t$
indepenedent over time with mean $0$ and constant variance, then you
would need $C^\ast(t) - C^\ast(t-L)$ to increase faster than linearly
with $L$. This is true if $C^\ast$ is growing exponentially.

Alternatively, if $\epsilon_t$ is not independent over time, but
negatively correlated (as seems likely), then variance can decrease with
$L$. For example, if $\Delta C(t) = C^\ast(t) - C^\ast(t-\delta)$ with
$\delta$ a random, independent increment with mean $1$, then variance
will tend to decrease with $L$ regardless of $C^\ast(t)$.

Results
-------

    20-element Array{Symbol,1}:
     Symbol("Stay.at.home..shelter.in.place")
     Symbol("Date.closed.K.12.schools")
     Symbol("Closed.gyms")
     Symbol("Closed.movie.theaters")
     Symbol("Closed.day.cares")
     Symbol("Date.banned.visitors.to.nursing.homes")
     Symbol("Closed.non.essential.businesses")
     Symbol("Closed.restaurants.except.take.out")
     :retail_and_recreation_percent_change_from_baseline
     :grocery_and_pharmacy_percent_change_from_baseline
     :parks_percent_change_from_baseline
     :transit_stations_percent_change_from_baseline
     :workplaces_percent_change_from_baseline
     :residential_percent_change_from_baseline
     :percentchangebusinesses
     :constant
     :logpopdens
     Symbol("Percent.Unemployed..2018.")
     Symbol("Percent.living.under.the.federal.poverty.line..2018.")
     Symbol("Percent.at.risk.for.serious.illness.due.to.COVID")

Here, we will allow the initial and time varying mean of $R_{s,t}$ to
depend on covariates.

$$
\begin{align*}
\tilde{R}_{s,0} & \sim N(X_{0,s} \alpha_0, \sigma^2_{R,0}) \\
\tilde{R}_{s,t} & = \rho \tilde{R}_{s,t} + u_{s,t} \;,\; u_{s,t} \sim
N(0, \sigma^2_R) \\
R_{s,t} & = X_{s,t} \alpha + \tilde{R}_{s,t} \\
\Delta \log(k)_{s,t} & = \gamma (R_{s,t} - 1) + \epsilon_{s,t} -
\epsilon_{s,t-1} \;, \; \epsilon_{s,t} \sim N(0, \sigma^2_k)
\end{align*}
$$

We present estimates of $R_t$ with $$
\Delta C(t) = C(t) - C(t-L_1)
$$

and

$$
\Delta log (\Delta C(t)) =  log (\Delta C(t)) -  log (\Delta C(t - L_2))
$$

for a variety of values of $L_1$ and $L_2$

``` julia
reestimate=false
rlo=-1 #1 - eps(Float64)
rhi=1.2 #1+ eps(Float64)
K = length(xvars)
priors = (γ = truncated(Normal(1/7,1/7), 1/28, 1/1),
          σR0 = truncated(Normal(1, 3), 0, Inf),
          α0 = MvNormal(zeros(length(x0vars)), sqrt(10)), #truncated(Normal(1, 3), 0, Inf),
          σR = truncated(Normal(0.25,1),0,Inf),
          σk = truncated(Normal(0.1, 5), 0, Inf),
          ρ = Uniform(rlo, rhi),
          α = MvNormal(zeros(K), sqrt(10))
          )

states_to_plot = ["New York", "New Jersey","Massachusetts","California",
                  "Georgia","Illinois","Michigan",
                  "Ohio","Wisconsin","Washington"]
warmup = default_warmup_stages(local_optimization=nothing,
                               stepsize_search=nothing,
                               init_steps=100, middle_steps=100,
                               terminating_steps=2*100,
                               doubling_stages=3, M=Symmetric)
for L1 in [3] #[1, 3, 7]
  for L2 in [3] #[1, 3, 7]
    mdl = CovidRt.RtModel(sdf, Symbol("cases.nyt"), xvars, x0vars,
                          priors; L1=L1, L2=L2,
                          time0=r->(r[Symbol("cases.nyt")].>=5))
    estfile = "rt$(L1)_$(L2).jld2"

    if !isfile(estfile) || reestimate
      post = CovidRt.mcmc(mdl; iterations=2000, warmup=warmup)
      @save estfile post
    end
    @load estfile post
    cc = CovidRt.MCMCChain(post, xvars, x0vars)
    #display("#####################################")
    #display("L₁ = $(L1), L₂ = $(L2)")
    show(stdout, "text/plain", Markdown.parse("## L₁ = $(L1), L₂ = $(L2)"))
    display(plot(cc))
    #display(describe(cc))
    show(stdout, "text/plain", latexify(DataFrame(describe(cc)[1]), env=:mdtable, latex=false, fmt=x->round(x, sigdigits=3)))
    show(stdout, "text/plain", latexify(DataFrame(describe(cc)[2]), env=:mdtable, latex=false, fmt=x->round(x, sigdigits=3)))
    states = mdl.id
    S = length(states_to_plot)
    figs = fill(plot(), S)
    for (i,st) in enumerate(states_to_plot)
      s = findfirst(states.==st)
      figr = CovidRt.plotpostr(mdl.t[s],mdl.dlogk[s],post, mdl.X[s], mdl.X0[s])
      l = @layout [a{.1h}; grid(1,1)]
      figs[i] = plot(plot(annotation=(0.5,0.5, st), framestyle = :none),
                     plot(figr, ylim=(-1,10)), layout=l)
      display(figs[i])
    end
  end
end
```

L₁ = 3, L₂ = 3
==============

                                             parameters   mean    std naive_se     mcse    ess r_hat

–––––––––––––––––––––––––––––––––––––––––––––––––––––––– –––––– ––––––
–––––––– –––––––– –––––– ––––– γ 0.163 0.0254 0.000569 0.00059 976.0 1.0
σR0 9.23 1.44 0.0322 0.0238 1330.0 1.0 α0\[constant\] 0.666 3.3 0.0737
0.0606 2930.0 1.0 α0\[logpopdens\] -0.818 1.46 0.0326 0.0308 2820.0 1.0
α0\[Percent.Unemployed..2018.\] 1.94 2.05 0.0458 0.0458 2600.0 1.0
α0\[Percent.living.under.the.federal.poverty.line..2018.\] -1.03 1.08
0.0241 0.0247 2490.0 1.0
α0\[Percent.at.risk.for.serious.illness.due.to.COVID\] 0.402 0.389
0.00869 0.00776 2530.0 1.0 σR 3.25 0.488 0.0109 0.0104 1040.0 1.0 σk
0.0176 0.0134 0.000299 0.000358 2350.0 1.0 ρ 0.557 0.0159 0.000356
0.000227 2330.0 1.0 α\[Stay.at.home..shelter.in.place\] -1.47 0.448 0.01
0.00838 2190.0 1.0 α\[Date.closed.K.12.schools\] -0.247 0.478 0.0107
0.00647 2660.0 1.0 α\[Closed.gyms\] -0.738 0.704 0.0157 0.0105 2640.0
1.0 α\[Closed.movie.theaters\] -0.12 0.735 0.0164 0.0108 2540.0 1.0
α\[Closed.day.cares\] -0.259 0.381 0.00851 0.00694 3330.0 1.0
α\[Date.banned.visitors.to.nursing.homes\] -0.273 0.32 0.00715 0.00645
2400.0 1.0 α\[Closed.non.essential.businesses\] -0.354 0.397 0.00887
0.00771 2350.0 1.0 α\[Closed.restaurants.except.take.out\] 0.253 0.547
0.0122 0.0101 2790.0 1.0
α\[retailandrecreationpercentchangefrombaseline\] -0.297 1.61 0.0359
0.0331 2750.0 1.0 α\[groceryandpharmacypercentchangefrombaseline\] 1.69
1.28 0.0287 0.0365 2700.0 1.0 α\[parkspercentchangefrombaseline\] -0.178
0.303 0.00677 0.00696 2550.0 1.0
α\[transitstationspercentchangefrom\_baseline\] 2.46 1.46 0.0327 0.0293
2560.0 1.0 α\[workplacespercentchangefrombaseline\] 1.25 1.52 0.0339
0.0296 2810.0 0.999 α\[residentialpercentchangefrombaseline\] 4.02 2.49
0.0556 0.0498 3260.0 1.0 α\[percentchangebusinesses\] -0.116 1.16 0.026
0.0235 3050.0 1.0 α\[constant\] 1.5 1.61 0.0361 0.0292 2460.0 1.0
α\[logpopdens\] 0.329 0.138 0.00309 0.00234 2710.0 1.0
α\[Percent.Unemployed..2018.\] 0.386 0.241 0.00539 0.00391 2950.0 1.0
\[Percent.living.under.the.federal.poverty.line..2018.\] -0.188 0.101
0.00226 0.00146 2890.0 1.0
α\[Percent.at.risk.for.serious.illness.due.to.COVID\] 0.0751 0.0501
0.00112 0.000779 2560.0 1.0

                                               parameters     2.5%   25.0%   50.0%    75.0%     97.5%

–––––––––––––––––––––––––––––––––––––––––––––––––––––––– ––––––––
––––––– ––––––– –––––––– ––––––––– γ 0.122 0.145 0.16 0.177 0.223 σR0
6.55 8.23 9.2 10.1 12.2 α0\[constant\] -5.74 -1.56 0.664 2.9 7.24
α0\[logpopdens\] -3.62 -1.85 -0.808 0.217 2.0
α0\[Percent.Unemployed..2018.\] -1.99 0.565 1.95 3.34 5.9
α0\[Percent.living.under.the.federal.poverty.line..2018.\] -3.19 -1.73
-1.04 -0.309 1.11 α0\[Percent.at.risk.for.serious.illness.due.to.COVID\]
-0.359 0.152 0.394 0.671 1.21 σR 2.34 2.91 3.22 3.57 4.24 σk 0.000796
0.00682 0.0146 0.0248 0.05 ρ 0.525 0.547 0.557 0.568 0.588
α\[Stay.at.home..shelter.in.place\] -2.38 -1.78 -1.44 -1.14 -0.684
α\[Date.closed.K.12.schools\] -1.18 -0.569 -0.228 0.0672 0.653
α\[Closed.gyms\] -2.14 -1.19 -0.74 -0.27 0.646
α\[Closed.movie.theaters\] -1.59 -0.625 -0.116 0.383 1.3
α\[Closed.day.cares\] -1.01 -0.515 -0.248 0.000724 0.493
α\[Date.banned.visitors.to.nursing.homes\] -0.961 -0.473 -0.257 -0.0551
0.329 α\[Closed.non.essential.businesses\] -1.18 -0.592 -0.336 -0.0883
0.382 α\[Closed.restaurants.except.take.out\] -0.8 -0.113 0.239 0.617
1.36 α\[retailandrecreationpercentchangefrombaseline\] -3.4 -1.38 -0.296
0.762 2.8 α\[groceryandpharmacypercentchangefrombaseline\] -0.786 0.836
1.67 2.51 4.18 α\[parkspercentchangefrombaseline\] -0.811 -0.369 -0.171
0.0251 0.405 α\[transitstationspercentchangefrom\_baseline\] -0.239 1.44
2.46 3.47 5.39 α\[workplacespercentchangefrombaseline\] -1.71 0.195 1.27
2.31 4.26 α\[residentialpercentchangefrombaseline\] -0.874 2.31 4.07
5.72 8.8 α\[percentchangebusinesses\] -2.4 -0.896 -0.0914 0.667 2.19
α\[constant\] -1.72 0.437 1.5 2.58 4.61 α\[logpopdens\] 0.0734 0.237
0.32 0.414 0.626 α\[Percent.Unemployed..2018.\] -0.0826 0.223 0.383
0.544 0.866 α\[Percent.living.under.the.federal.poverty.line..2018.\]
-0.396 -0.252 -0.187 -0.12 -0.000843
α\[Percent.at.risk.for.serious.illness.due.to.COVID\] -0.0203 0.0411
0.0736 0.108 0.177 ![](figures/rt_longdiff_2_1.png)
![](figures/rt_longdiff_2_2.png) ![](figures/rt_longdiff_2_3.png)
![](figures/rt_longdiff_2_4.png) ![](figures/rt_longdiff_2_5.png)
![](figures/rt_longdiff_2_6.png) ![](figures/rt_longdiff_2_7.png)
![](figures/rt_longdiff_2_8.png) ![](figures/rt_longdiff_2_9.png)
![](figures/rt_longdiff_2_10.png) ![](figures/rt_longdiff_2_11.png)
