<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Paul Schrimpf">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Long-differening - CovidRt.jl</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atelier-dune-light.min.css">
        <link href="../assets/Documenter.css" rel="stylesheet">
        <link href="../assets/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">CovidRt.jl</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Package Docs</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Reproductive number estimates <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Rt/" class="dropdown-item">Systrom Approach</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Long-differening</a>
</li>
                                    
<li>
    <a href="../extensions/" class="dropdown-item">Extensions</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Rt/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../extensions/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/schrimpf/CovidRt.jl/edit/master/docs/rt_longdiff.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#longer-differences-and-smoothing" class="nav-link">Longer Differences and Smoothing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#results" class="nav-link">Results</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#l1-1-l2-1" class="nav-link">L₁ = 1, L₂ = 1</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="longer-differences-and-smoothing">Longer Differences and Smoothing<a class="headerlink" href="#longer-differences-and-smoothing" title="Permanent link">&para;</a></h2>
<p>One way to reduce $\sigma_k/\sigma_R$ is to reduce noise in new cases by
taking a longer difference or smoothing case counts in some other way.
How does this affect the estimation and interpretation of $R_t$?</p>
<p>As in the first section, we start with the approximate recursive
relation <script type="math/tex; mode=display">
C(t) - C(t-1) \equiv \Delta C(t) \approx \frac{\tau(t)}{\tau(t-1)} e^{\gamma (R_t - 1)} \Delta C(t-1)
</script> If we instead look at a longer difference, <script type="math/tex; mode=display">
\begin{align*}
C(t) - C(t-L) = & \sum_{i=0}^{L-1} \Delta C_{t-i} \\
\approx & \sum_{i=0}^{L-1} \frac{\tau(t-i)}{\tau(t-i-1)} e^{\gamma (R_{t-i} - 1)} \Delta C_{t-i-1} \\
= & \overline {T_{t,L} e^{\gamma(R_{t,L} - 1)}} \sum_{i=0}^{L-1}\Delta C_{t-i-1} \\
= & \overline {T_{t,L} e^{\gamma(R_{t,L} - 1)}} \left( C(t-1) - C(t-1-L) \right)
\end{align*}
</script> where $\overline {T_{t,L} e^{\gamma(R_{t,L} - 1)}}$ is some
intermediate value in between the minimum and maximum of the
${ \frac{\tau(t-i)}{\tau(t-i-1)} e^{\gamma (R_{t-i} - 1)} }_{i=0}^{L-1}$.</p>
<p>If testing is constant over time, we can then obtain an interpretable
$\overline{R_{t,L}}$ by using $k_{t,L} =\log(C(t)-C(t-L))$ and following
the procedure above.</p>
<p>If testing varies with time, it becomes hard to separate testing rate
changes from $R_t$ after taking long differnces.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The same analysis can be applied to other smoothing operations, i.e. using
<script type="math/tex; mode=display">
\sum_{i=0}^L w_i \Delta C_{t-i}
</script>
in place of $C(t) - C(t-L)$. However, there&rsquo;s something strange
about smoothing $C_t$, and then extracting a smoothed component of
it using the Kalman filter. The inference afterwards is suspect;
we would essentially be estimating a kernel regression of $C_t$ on
time, and using the estimated regression as though it&rsquo;s known with
certainty.</p>
</div>
<p>When would long differences reduce variance? Well if
$\Delta C(t) = \Delta C^\ast(t) + \epsilon_t$ with $\epsilon_t$
indepenedent over time with mean $0$ and constant variance, then you
would need $C^\ast(t) - C^\ast(t-L)$ to increase faster than linearly
with $L$. This is true if $C^\ast$ is growing exponentially.</p>
<p>Alternatively, if $\epsilon_t$ is not independent over time, but
negatively correlated (as seems likely), then variance can decrease with
$L$. For example, if $\Delta C(t) = C^\ast(t) - C^\ast(t-\delta)$ with
$\delta$ a random, independent increment with mean $1$, then variance
will tend to decrease with $L$ regardless of $C^\ast(t)$.</p>
<h2 id="results">Results<a class="headerlink" href="#results" title="Permanent link">&para;</a></h2>
<pre><code>20-element Array{Symbol,1}:
 Symbol("Stay.at.home..shelter.in.place")
 Symbol("Date.closed.K.12.schools")
 Symbol("Closed.gyms")
 Symbol("Closed.movie.theaters")
 Symbol("Closed.day.cares")
 Symbol("Date.banned.visitors.to.nursing.homes")
 Symbol("Closed.non.essential.businesses")
 Symbol("Closed.restaurants.except.take.out")
 :retail_and_recreation_percent_change_from_baseline
 :grocery_and_pharmacy_percent_change_from_baseline
 :parks_percent_change_from_baseline
 :transit_stations_percent_change_from_baseline
 :workplaces_percent_change_from_baseline
 :residential_percent_change_from_baseline
 :percentchangebusinesses
 :constant
 :logpopdens
 Symbol("Percent.Unemployed..2018.")
 Symbol("Percent.living.under.the.federal.poverty.line..2018.")
 Symbol("Percent.at.risk.for.serious.illness.due.to.COVID")
</code></pre>
<p>Here, we will allow the initial and time varying mean of $R_{s,t}$ to
depend on covariates.</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
\tilde{R}_{s,0} & \sim N(X_{0,s} \alpha_0, \sigma^2_{R,0}) \\
\tilde{R}_{s,t} & = \rho \tilde{R}_{s,t} + u_{s,t} \;,\; u_{s,t} \sim
N(0, \sigma^2_R) \\
R_{s,t} & = X_{s,t} \alpha + \tilde{R}_{s,t} \\
\Delta \log(k)_{s,t} & = \gamma (R_{s,t} - 1) + \epsilon_{s,t} -
\epsilon_{s,t-1} \;, \; \epsilon_{s,t} \sim N(0, \sigma^2_k)
\end{align*}
</script>
</p>
<p>We present estimates of $R_t$ with <script type="math/tex; mode=display">
\Delta C(t) = C(t) - C(t-L_1)
</script>
</p>
<p>and</p>
<p>
<script type="math/tex; mode=display">
\Delta log (\Delta C(t)) =  log (\Delta C(t)) -  log (\Delta C(t - L_2))
</script>
</p>
<p>for a variety of values of $L_1$ and $L_2$</p>
<pre><code class="julia">reestimate=false
rlo=-1 #1 - eps(Float64)
rhi=1.2 #1+ eps(Float64)
K = length(xvars)
priors = (γ = truncated(Normal(1/7,1/7), 1/28, 1/1),
          σR0 = truncated(Normal(1, 3), 0, Inf),
          α0 = MvNormal(zeros(length(x0vars)), sqrt(10)), #truncated(Normal(1, 3), 0, Inf),
          σR = truncated(Normal(0.25,1),0,Inf),
          σk = truncated(Normal(0.1, 5), 0, Inf),
          ρ = Uniform(rlo, rhi),
          α = MvNormal(zeros(K), sqrt(10))
          )

states_to_plot = [&quot;New York&quot;, &quot;New Jersey&quot;,&quot;Massachusetts&quot;,&quot;California&quot;,
                  &quot;Georgia&quot;,&quot;Illinois&quot;,&quot;Michigan&quot;,
                  &quot;Ohio&quot;,&quot;Wisconsin&quot;,&quot;Washington&quot;]
warmup = default_warmup_stages(local_optimization=nothing,
                               stepsize_search=nothing,
                               init_steps=100, middle_steps=100,
                               terminating_steps=2*100,
                               doubling_stages=3, M=Symmetric)
for L1 in [1, 3, 7]
  for L2 in [1, 3, 7]
    mdl = CovidRt.RtModel(sdf, Symbol(&quot;cases.nyt&quot;), xvars, x0vars,
                          priors; L1=L1, L2=L2,
                          time0=r-&gt;(r[Symbol(&quot;cases.nyt&quot;)].&gt;=5))
    estfile = &quot;rt$(L1)_$(L2).jld2&quot;

    if !isfile(estfile) || reestimate
      post = CovidRt.mcmc(mdl; iterations=2000, warmup=warmup)
      @save estfile post
    end
    @load estfile post
    cc = CovidRt.MCMCChain(post, xvars, x0vars)

    println(&quot;## L₁ = $(L1), L₂ = $(L2)&quot;)
    println()

    display(plot(cc))

    println(latexify(DataFrame(describe(cc)[1]), env=:mdtable, latex=false, fmt=x-&gt;round(x, sigdigits=3)))
    println(latexify(DataFrame(describe(cc)[2]), env=:mdtable, latex=false, fmt=x-&gt;round(x, sigdigits=3)))
    states = mdl.id
    S = length(states_to_plot)
    figs = fill(plot(), S)
    for (i,st) in enumerate(states_to_plot)
      s = findfirst(states.==st)
      figr = CovidRt.plotpostr(mdl.t[s],mdl.dlogk[s],post, mdl.X[s], mdl.X0[s])
      l = @layout [a{.1h}; grid(1,1)]
      figs[i] = plot(plot(annotation=(0.5,0.5, st), framestyle = :none),
                     plot(figr, ylim=(-1,10)), layout=l)
      display(figs[i])
    end
  end
end
</code></pre>

<h2 id="l1-1-l2-1">L₁ = 1, L₂ = 1<a class="headerlink" href="#l1-1-l2-1" title="Permanent link">&para;</a></h2>
<p>Error: UndefVarError: latexify not defined</p>
<p><img alt="" src="../figures/rt_longdiff_2_1.png" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Paul Schrimpf</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../assets/mathjaxhelper.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
